<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스윙 히스토리 - INSWING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* 네비게이션 바 */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.6);
            z-index: 100;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-logo-mark {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 0.14em;
        }

        .nav-logo-text {
            color: #e5e7eb;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .nav-link:hover {
            color: #e5e7eb;
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .nav-link.active {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .nav-link.logout {
            color: #f97316;
        }

        .nav-link.logout:hover {
            background: rgba(249, 115, 22, 0.1);
            border-color: rgba(249, 115, 22, 0.3);
        }

        /* 메인 레이아웃 */
        .container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        .toolbar-left {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .toolbar-right {
            display: flex;
            gap: 0.5rem;
        }

        .filter-select {
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.7);
            color: #e5e7eb;
            font-size: 0.85rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.9rem 1rem;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #0ea5e9;
            background: rgba(15, 23, 42, 0.9);
            transform: translateY(-1px);
        }

        .history-main {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .history-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e5e7eb;
        }

        .history-meta {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .history-tag-row {
            margin-top: 0.2rem;
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: #94a3b8;
        }

        .badge.club {
            border-color: rgba(14, 165, 233, 0.7);
            color: #0ea5e9;
        }

        .badge.side {
            border-color: rgba(34, 197, 94, 0.7);
            color: #22c55e;
        }

        .badge.score {
            border-color: rgba(234, 179, 8, 0.7);
            color: #facc15;
        }

        .badge.feeling {
            border-color: rgba(244, 114, 182, 0.7);
            color: #f9a8d4;
        }

        .history-score {
            font-size: 1.1rem;
            font-weight: 700;
            color: #facc15;
        }

        .history-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @media (max-width: 768px) {
            .top-nav {
                height: 56px;
                padding: 0 1rem;
            }

            body {
                padding-top: 72px;
            }

            .nav-logo-text {
                display: none;
            }

            .nav-menu {
                gap: 0.3rem;
            }

            .nav-link {
                padding: 0.4rem 0.7rem;
                font-size: 0.8rem;
            }

            .card {
                padding: 1.25rem;
            }

            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.4rem;
            }

            .history-score {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 -->
    <nav class="top-nav">
        <a href="/ko/index.html" class="nav-logo">
            <span class="nav-logo-mark">INS</span>
            <span class="nav-logo-text">WING</span>
        </a>
        <div class="nav-menu">
            <a href="/app/upload.html" class="nav-link">업로드</a>
            <a href="/app/history.html" class="nav-link active">히스토리</a>
            <a href="#" onclick="logout(); return false;" class="nav-link logout">로그아웃</a>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="container">
        <div class="header">
            <h1>스윙 히스토리</h1>
            <p class="subtitle">지금까지 기록한 스윙과 AI 분석 결과를 한눈에 확인해보세요.</p>
        </div>

        <div class="card">
            <div class="toolbar">
                <div class="toolbar-left">
                    <span id="historyCountText">스윙 기록을 불러오는 중입니다...</span>
                </div>
                <div class="toolbar-right">
                    <select id="clubFilter" class="filter-select">
                        <option value="">전체 클럽</option>
                        <option value="driver">드라이버</option>
                        <option value="wood">우드</option>
                        <option value="iron">아이언</option>
                        <option value="wedge">웨지</option>
                        <option value="putter">퍼터</option>
                    </select>
                    <select id="sideFilter" class="filter-select">
                        <option value="">전체 방향</option>
                        <option value="front">정면</option>
                        <option value="side">측면</option>
                        <option value="back">후면</option>
                    </select>
                </div>
            </div>

            <div id="loadingDiv" class="loading">
                스윙 리스트를 불러오는 중
            </div>

            <div id="historyList" class="history-list" style="display:none;"></div>

            <div id="emptyDiv" class="history-empty" style="display:none;">
                아직 기록된 스윙이 없습니다.<br />
                <a href="/app/upload.html" style="color:#0ea5e9; text-decoration:underline;">첫 번째 스윙을 업로드</a>해보세요.
            </div>
        </div>
    </div>

    <script src="/app/js/app.js"></script>
    <script>
        // 로그인 체크
        requireLogin();

        const loadingDiv = document.getElementById('loadingDiv');
        const historyList = document.getElementById('historyList');
        const emptyDiv = document.getElementById('emptyDiv');
        const historyCountText = document.getElementById('historyCountText');
        const clubFilter = document.getElementById('clubFilter');
        const sideFilter = document.getElementById('sideFilter');

        const clubNames = {
            driver: '드라이버',
            wood: '우드',
            iron: '아이언',
            wedge: '웨지',
            putter: '퍼터'
        };

        const sideNames = {
            front: '정면',
            side: '측면',
            back: '후면'
        };

        let allSwings = [];

        function formatDate(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function safeNumber(value, fixed) {
            if (value === null || value === undefined) return null;
            const num = Number(value);
            if (Number.isNaN(num)) return null;
            return typeof fixed === 'number' ? num.toFixed(fixed) : String(num);
        }

        function feelingLabel(feelingCode) {
            if (!feelingCode) return null;
            switch (feelingCode) {
                case 'perfect': return '완벽했어요';
                case 'good': return '괜찮았어요';
                case 'normal': return '보통이에요';
                case 'bad': return '아쉬웠어요';
                default: return feelingCode;
            }
        }

        function applyFilters() {
            const club = clubFilter.value;
            const side = sideFilter.value;

            let filtered = [...allSwings];

            if (club) {
                filtered = filtered.filter(s => s.club_type === club);
            }
            if (side) {
                filtered = filtered.filter(s => s.shot_side === side);
            }

            renderList(filtered);
        }

        function renderList(swings) {
            historyList.innerHTML = '';

            if (!swings || swings.length === 0) {
                historyList.style.display = 'none';
                emptyDiv.style.display = 'block';
                historyCountText.textContent = '기록된 스윙이 없습니다.';
                return;
            }

            historyList.style.display = 'flex';
            emptyDiv.style.display = 'none';
            historyCountText.textContent = `총 ${swings.length}개의 스윙 기록`;

            swings.forEach(swing => {
                const item = document.createElement('div');
                item.className = 'history-item';

                const main = document.createElement('div');
                main.className = 'history-main';

                // 제목: 클럽 / 방향
                const title = document.createElement('div');
                title.className = 'history-title';
                const clubText = clubNames[swing.club_type] || swing.club_type || '클럽 미상';
                const sideText = sideNames[swing.shot_side] || swing.shot_side || '방향 미상';
                title.textContent = `${clubText} / ${sideText}`;

                // 날짜
                const meta = document.createElement('div');
                meta.className = 'history-meta';
                meta.textContent = formatDate(swing.created_at);

                // 태그들
                const tags = document.createElement('div');
                tags.className = 'history-tag-row';

                const clubBadge = document.createElement('span');
                clubBadge.className = 'badge club';
                clubBadge.textContent = clubText;
                tags.appendChild(clubBadge);

                const sideBadge = document.createElement('span');
                sideBadge.className = 'badge side';
                sideBadge.textContent = sideText;
                tags.appendChild(sideBadge);

                // 느낌(feeling) 태그 (있으면)
                if (swing.feeling && swing.feeling.feeling_code) {
                    const fLabel = feelingLabel(swing.feeling.feeling_code);
                    if (fLabel) {
                        const feelingBadge = document.createElement('span');
                        feelingBadge.className = 'badge feeling';
                        feelingBadge.textContent = fLabel;
                        tags.appendChild(feelingBadge);
                    }
                }

                // 점수 (metrics.overall_score)
                const metrics = swing.metrics || {};
                const scoreValue = safeNumber(metrics.overall_score, 0);

                if (scoreValue !== null) {
                    const scoreBadge = document.createElement('span');
                    scoreBadge.className = 'badge score';
                    scoreBadge.textContent = `점수 ${scoreValue}`;
                    tags.appendChild(scoreBadge);
                }

                main.appendChild(title);
                main.appendChild(meta);
                main.appendChild(tags);

                // 우측 점수 / 아이콘
                const right = document.createElement('div');
                const scoreText = document.createElement('div');
                scoreText.className = 'history-score';

                if (scoreValue !== null) {
                    scoreText.textContent = scoreValue;
                } else {
                    scoreText.textContent = '▶';
                    scoreText.style.fontSize = '1.2rem';
                }

                right.appendChild(scoreText);

                item.appendChild(main);
                item.appendChild(right);

                // 클릭 시 result 페이지로 이동
                item.addEventListener('click', () => {
                    if (!swing.id) {
                        console.warn('스윙 ID 없음:', swing);
                        return;
                    }
                    window.location.href = `/app/result.html?id=${swing.id}`;
                });

                historyList.appendChild(item);
            });
        }

        async function loadHistory() {
            try {
                const response = await apiFetch('/swings');
                if (!response.ok) {
                    throw new Error('스윙 리스트 응답 오류');
                }

                const data = await response.json();

                // /swings 응답 구조: { ok: true, swings: [...] }
                let swings = [];
                if (Array.isArray(data.swings)) {
                    swings = data.swings;
                } else if (Array.isArray(data)) {
                    swings = data;
                } else {
                    console.warn('알 수 없는 스윙 리스트 응답 형태:', data);
                }

                // 최신순 정렬 (created_at 기준 내림차순)
                swings.sort((a, b) => {
                    const ta = new Date(a.created_at).getTime();
                    const tb = new Date(b.created_at).getTime();
                    return tb - ta;
                });

                allSwings = swings;

                loadingDiv.style.display = 'none';
                applyFilters();
            } catch (error) {
                console.error('히스토리 로드 오류:', error);
                loadingDiv.textContent = '스윙 리스트를 불러오는 중 오류가 발생했습니다.';
            }
        }

        clubFilter.addEventListener('change', applyFilters);
        sideFilter.addEventListener('change', applyFilters);

        loadHistory();
    </script>
</body>
</html>
