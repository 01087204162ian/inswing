<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ìœ™ íˆìŠ¤í† ë¦¬ - INSWING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.6);
            z-index: 100;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-logo-mark {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 0.14em;
        }

        .nav-logo-text {
            color: #e5e7eb;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap; /* í•œê¸€ ë©”ë‰´ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .nav-link:hover {
            color: #e5e7eb;
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .nav-link.active {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .nav-link.logout {
            color: #f97316;
        }

        .nav-link.logout:hover {
            background: rgba(249, 115, 22, 0.1);
            border-color: rgba(249, 115, 22, 0.3);
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        .toolbar-left {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .toolbar-right {
            display: flex;
            gap: 0.5rem;
        }

        .filter-select {
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.7);
            color: #e5e7eb;
            font-size: 0.85rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.9rem 1rem;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #0ea5e9;
            background: rgba(15, 23, 42, 0.9);
            transform: translateY(-1px);
        }

        .history-left {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .thumb-circle {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 30% 30%, #22c55e33, #0f172a);
            flex-shrink: 0;
        }

        .thumb-circle span {
            font-size: 1rem;
            color: #e5e7eb;
        }

        .history-main {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .history-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e5e7eb;
        }

        .history-meta {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .history-comment {
            margin-top: 0.4rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            color: #e5e7eb;
            background: rgba(15, 23, 42, 0.6);
            border-left: 3px solid rgba(96, 165, 250, 0.6);
            border-radius: 6px;
            line-height: 1.5;
        }

        .history-comment-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.3rem;
            font-size: 0.75rem;
            color: #60a5fa;
            font-weight: 600;
        }

        .ai-coaching-icon {
            font-size: 0.9rem;
        }

        .history-tag-row {
            margin-top: 0.3rem;
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: #94a3b8;
        }

        .badge.club {
            border-color: rgba(14, 165, 233, 0.7);
            color: #0ea5e9;
        }

        .badge.side {
            border-color: rgba(34, 197, 94, 0.7);
            color: #22c55e;
        }

        .badge.score {
            border-color: rgba(234, 179, 8, 0.7);
            color: #facc15;
        }

        .badge.feeling {
            border-color: rgba(244, 114, 182, 0.7);
            color: #f9a8d4;
        }
        
        .badge.routine {
            border-color: rgba(52, 211, 153, 0.8);
            color: #4ade80;
        }

        .badge.compare-negative {
            background: rgba(255, 106, 106, 0.15);
            border-color: rgba(255, 106, 106, 0.5);
            color: #FF6A6A;
        }

        .badge.compare-positive {
            background: rgba(60, 179, 113, 0.15);
            border-color: rgba(60, 179, 113, 0.5);
            color: #3CB371;
        }

        .badge.compare-neutral {
            background: rgba(106, 106, 106, 0.15);
            border-color: rgba(106, 106, 106, 0.5);
            color: #6A6A6A;
        }

        .compare-tag-row {
            margin-top: 0.4rem;
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .compare-tag {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.75rem; /* ì•½ 12px */
            font-weight: 500;
            line-height: 1.4;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .compare-tag {
                font-size: 0.7rem; /* ì•½ 11px */
            }
        }
        .history-score {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .score-great {
            color: #4ade80; /* 80â†‘ */
        }

        .score-good {
            color: #38bdf8; /* 60â†‘ */
        }

        .score-mid {
            color: #facc15; /* 40â†‘ */
        }

        .score-low {
            color: #fb7185; /* 0~39 */
        }

        .history-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @media (max-width: 768px) {
            .top-nav {
                height: 56px;
                padding: 0 0.75rem;
                overflow-x: auto; /* ë„ˆë¬´ ì¢ìœ¼ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ ì²˜ë¦¬ */
            }

            body {
                padding-top: 72px;
            }

            .nav-logo-text {
                display: none;
            }

            .nav-menu {
                gap: 0.3rem;
                flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ ìœ ì§€ */
            }

            .nav-link {
                padding: 0.35rem 0.65rem;
                font-size: 0.78rem;
            }

            .card {
                padding: 1.25rem;
            }

            .history-item {
                flex-direction: row;
                align-items: center;
            }

            .history-score {
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="top-nav">
        <a href="/ko/index.html" class="nav-logo">
            <span class="nav-logo-mark">INS</span>
            <span class="nav-logo-text">WING</span>
        </a>
        <div class="nav-menu">
            <a href="/app/upload.html" class="nav-link">ì—…ë¡œë“œ</a>
            <a href="/app/history.html" class="nav-link active">íˆìŠ¤í† ë¦¬</a>
            <a href="/app/training.html" class="nav-link">íŠ¸ë ˆì´ë‹</a>
            <a href="/app/routine.html" class="nav-link">ë£¨í‹´</a>
            <a href="#" onclick="logout(); return false;" class="nav-link logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container">
        <div class="header">
            <h1>ìŠ¤ìœ™ íˆìŠ¤í† ë¦¬</h1>
            <p class="subtitle">ì§€ê¸ˆê¹Œì§€ ê¸°ë¡í•œ ìŠ¤ìœ™ê³¼ AI ë¶„ì„ ê²°ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•´ë³´ì„¸ìš”.</p>
        </div>

        <div class="card">
            <div class="toolbar">
                <div class="toolbar-left">
                    <span id="historyCountText">ìŠ¤ìœ™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
                <div class="toolbar-right">
                    <select id="clubFilter" class="filter-select">
                        <option value="">ì „ì²´ í´ëŸ½</option>
                        <option value="driver">ë“œë¼ì´ë²„</option>
                        <option value="wood">ìš°ë“œ</option>
                        <option value="iron">ì•„ì´ì–¸</option>
                        <option value="wedge">ì›¨ì§€</option>
                        <option value="putter">í¼í„°</option>
                    </select>
                    <select id="sideFilter" class="filter-select">
                        <option value="">ì „ì²´ ë°©í–¥</option>
                        <option value="front">ì •ë©´</option>
                        <option value="side">ì¸¡ë©´</option>
                        <option value="back">í›„ë©´</option>
                    </select>
                </div>
            </div>

            <div id="loadingDiv" class="loading">
                ìŠ¤ìœ™ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘
            </div>

            <div id="historyList" class="history-list" style="display:none;"></div>

            <div id="emptyDiv" class="history-empty" style="display:none;">
                ì•„ì§ ê¸°ë¡ëœ ìŠ¤ìœ™ì´ ì—†ìŠµë‹ˆë‹¤.<br />
                <a href="/app/upload.html" style="color:#0ea5e9; text-decoration:underline;">ì²« ë²ˆì§¸ ìŠ¤ìœ™ì„ ì—…ë¡œë“œ</a>í•´ë³´ì„¸ìš”.
            </div>
        </div>
    </div>

    <script src="/app/js/app.js"></script>
    <script>
        requireLogin();

        const loadingDiv = document.getElementById('loadingDiv');
        const historyList = document.getElementById('historyList');
        const emptyDiv = document.getElementById('emptyDiv');
        const historyCountText = document.getElementById('historyCountText');
        const clubFilter = document.getElementById('clubFilter');
        const sideFilter = document.getElementById('sideFilter');

        const clubNames = {
            driver: 'ë“œë¼ì´ë²„',
            wood: 'ìš°ë“œ',
            iron: 'ì•„ì´ì–¸',
            wedge: 'ì›¨ì§€',
            putter: 'í¼í„°'
        };

        const sideNames = {
            front: 'ì •ë©´',
            side: 'ì¸¡ë©´',
            back: 'í›„ë©´'
        };

        let allSwings = [];

        function formatDate(isoString) {
            if (!isoString) return '-';
            const d = new Date(isoString);
            return d.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function safeNumber(value, fixed) {
            if (value === null || value === undefined) return null;
            const num = Number(value);
            if (Number.isNaN(num)) return null;
            return typeof fixed === 'number' ? num.toFixed(fixed) : String(num);
        }

        function feelingLabel(feelingCode) {
            if (!feelingCode) return null;
            switch (feelingCode) {
                case 'perfect': return 'ì™„ë²½í–ˆì–´ìš”';
                case 'good': return 'ê´œì°®ì•˜ì–´ìš”';
                case 'normal': return 'ë³´í†µì´ì—ìš”';
                case 'bad': return 'ì•„ì‰¬ì› ì–´ìš”';
                default: return feelingCode;
            }
        }

        function scoreClass(scoreNumber) {
            if (scoreNumber == null || Number.isNaN(scoreNumber)) return 'score-mid';
            if (scoreNumber >= 80) return 'score-great';
            if (scoreNumber >= 60) return 'score-good';
            if (scoreNumber >= 40) return 'score-mid';
            return 'score-low';
        }

        function applyFilters() {
            const club = clubFilter.value;
            const side = sideFilter.value;

            let filtered = [...allSwings];

            if (club) {
                filtered = filtered.filter(s => s.club_type === club);
            }
            if (side) {
                filtered = filtered.filter(s => s.shot_side === side);
            }

            renderList(filtered);
        }

        function renderList(swings) {
            historyList.innerHTML = '';

            if (!swings || swings.length === 0) {
                historyList.style.display = 'none';
                emptyDiv.style.display = 'block';
                historyCountText.textContent = 'ê¸°ë¡ëœ ìŠ¤ìœ™ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            historyList.style.display = 'flex';
            emptyDiv.style.display = 'none';
            historyCountText.textContent = `ì´ ${swings.length}ê°œì˜ ìŠ¤ìœ™ ê¸°ë¡`;

            swings.forEach(swing => {
                const item = document.createElement('div');
                item.className = 'history-item';

                // ì™¼ìª½ (ì•„ì´ì½˜ + í…ìŠ¤íŠ¸)
                const left = document.createElement('div');
                left.className = 'history-left';

                const thumb = document.createElement('div');
                thumb.className = 'thumb-circle';
                const thumbIcon = document.createElement('span');
                thumbIcon.textContent = 'â–¶';
                thumb.appendChild(thumbIcon);

                const main = document.createElement('div');
                main.className = 'history-main';

                const clubText = clubNames[swing.club_type] || swing.club_type || 'í´ëŸ½ ë¯¸ìƒ';
                const sideText = sideNames[swing.shot_side] || swing.shot_side || 'ë°©í–¥ ë¯¸ìƒ';

                // ì œëª©
                const title = document.createElement('div');
                title.className = 'history-title';
                title.textContent = `${clubText} / ${sideText}`;

                // AI ì½”ì¹­ ë¯¸ë¦¬ë³´ê¸° (60ì ì œí•œ) - ì œëª© ë°”ë¡œ ì•„ë˜
                if (swing.comment) {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'history-comment';
                    
                    // AI ì½”ì¹­ í—¤ë”
                    const header = document.createElement('div');
                    header.className = 'history-comment-header';
                    const icon = document.createElement('span');
                    icon.className = 'ai-coaching-icon';
                    icon.textContent = 'ğŸ¤–';
                    const label = document.createElement('span');
                    label.textContent = 'Claude AI ì½”ì¹­';
                    header.appendChild(icon);
                    header.appendChild(label);
                    commentDiv.appendChild(header);
                    
                    // ì½”ì¹­ ìŠ¤ë‹ˆí« (60ì ì œí•œ)
                    const snippet = document.createElement('div');
                    const trimmed = swing.comment.trim();
                    snippet.textContent = trimmed.length > 60 ? trimmed.slice(0, 60) + 'â€¦' : trimmed;
                    commentDiv.appendChild(snippet);
                    
                    main.appendChild(commentDiv);
                }

                // í‰ì†Œ ëŒ€ë¹„ ë¹„êµ íƒœê·¸ (comment ì•„ë˜, ë‚ ì§œ ìœ„)
                if (swing.previous_compare_tag) {
                    const compareTagRow = document.createElement('div');
                    compareTagRow.className = 'compare-tag-row';

                    const compareTag = document.createElement('span');
                    compareTag.className = 'compare-tag';
                    
                    // íƒœê·¸ í…ìŠ¤íŠ¸
                    compareTag.textContent = swing.previous_compare_tag;

                    // ìƒ‰ìƒ ë¶„ë¥˜
                    const tagText = swing.previous_compare_tag;
                    if (tagText.includes('ì•ˆì •') || tagText.includes('ê°œì„ ')) {
                        // ê¸ì •: ì•ˆì •/ê°œì„ 
                        compareTag.classList.add('compare-positive');
                    } else if (tagText.includes('ìœ ì§€')) {
                        // ì¤‘ë¦½: ìœ ì§€
                        compareTag.classList.add('compare-neutral');
                    } else {
                        // ë¶€ì •: ì¦ê°€/í”ë“¤ë¦¼/ë¹ ë¦„/ëŠë¦¼/ê°ì†Œ ë“±
                        compareTag.classList.add('compare-negative');
                    }

                    compareTagRow.appendChild(compareTag);
                    main.appendChild(compareTagRow);
                }

                // ë‚ ì§œ
                const meta = document.createElement('div');
                meta.className = 'history-meta';
                meta.textContent = formatDate(swing.created_at);

                // íƒœê·¸ë“¤
                const tags = document.createElement('div');
                tags.className = 'history-tag-row';

                const clubBadge = document.createElement('span');
                clubBadge.className = 'badge club';
                clubBadge.textContent = clubText;
                tags.appendChild(clubBadge);

                const sideBadge = document.createElement('span');
                sideBadge.className = 'badge side';
                sideBadge.textContent = sideText;
                tags.appendChild(sideBadge);

                // ğŸ”¥ ì˜¤ëŠ˜ ì§„í–‰ ì¤‘ ë£¨í‹´ì— í¬í•¨ëœ ìŠ¤ìœ™ì´ë©´ ë°°ì§€ ì¶”ê°€
                if (swing.in_active_routine) {
                    const routineBadge = document.createElement('span');
                    routineBadge.className = 'badge routine';
                    // ì˜¤ëŠ˜ + ë£¨í‹´ì´ë©´ ë¬¸êµ¬ ì¡°ê¸ˆ ê°•ì¡°
                    routineBadge.textContent = swing.is_today
                    ? 'ì˜¤ëŠ˜ ë£¨í‹´ ìŠ¤ìœ™'
                    : 'ë£¨í‹´ ìŠ¤ìœ™';
                    tags.appendChild(routineBadge);
                }


                if (swing.feeling && swing.feeling.feeling_code) {
                    const fLabel = feelingLabel(swing.feeling.feeling_code);
                    if (fLabel) {
                        const feelingBadge = document.createElement('span');
                        feelingBadge.className = 'badge feeling';
                        feelingBadge.textContent = fLabel;
                        tags.appendChild(feelingBadge);
                    }
                }

                const metrics = swing.metrics || {};
                const scoreValueStr = safeNumber(metrics.overall_score, 0);
                let scoreNumber = null;
                if (scoreValueStr !== null) {
                    scoreNumber = Number(scoreValueStr);
                    const scoreBadge = document.createElement('span');
                    scoreBadge.className = 'badge score';
                    scoreBadge.textContent = `ì ìˆ˜ ${scoreValueStr}`;
                    tags.appendChild(scoreBadge);
                }

                main.appendChild(title);
                main.appendChild(meta);
                main.appendChild(tags);

                left.appendChild(thumb);
                left.appendChild(main);

                // ì˜¤ë¥¸ìª½ ì ìˆ˜
                const right = document.createElement('div');
                const scoreText = document.createElement('div');
                scoreText.className = 'history-score';

                if (scoreValueStr !== null) {
                    scoreText.textContent = scoreValueStr;
                    scoreText.classList.add(scoreClass(scoreNumber));
                } else {
                    scoreText.textContent = 'â–¶';
                    scoreText.classList.add('score-mid');
                }

                right.appendChild(scoreText);

                item.appendChild(left);
                item.appendChild(right);

                item.addEventListener('click', () => {
                    if (!swing.id) {
                        console.warn('ìŠ¤ìœ™ ID ì—†ìŒ:', swing);
                        return;
                    }
                    window.location.href = `/app/result.html?id=${swing.id}`;
                });

                historyList.appendChild(item);
            });
        }

        async function loadHistory() {
            try {
                const response = await apiFetch('/swings');
                if (!response.ok) {
                    throw new Error('ìŠ¤ìœ™ ë¦¬ìŠ¤íŠ¸ ì‘ë‹µ ì˜¤ë¥˜');
                }

                const data = await response.json();

                let swings = [];
                if (Array.isArray(data.swings)) {
                    swings = data.swings;
                } else if (Array.isArray(data)) {
                    swings = data;
                } else {
                    console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ìŠ¤ìœ™ ë¦¬ìŠ¤íŠ¸ ì‘ë‹µ í˜•íƒœ:', data);
                }

                swings.sort((a, b) => {
                    const ta = new Date(a.created_at).getTime();
                    const tb = new Date(b.created_at).getTime();
                    return tb - ta;
                });

                allSwings = swings;

                loadingDiv.style.display = 'none';
                applyFilters();
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                loadingDiv.textContent = 'ìŠ¤ìœ™ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        clubFilter.addEventListener('change', applyFilters);
        sideFilter.addEventListener('change', applyFilters);

        loadHistory();
    </script>
</body>
</html>
