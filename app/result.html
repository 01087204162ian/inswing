<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>INSWING - ìŠ¤ìœ™ ë¶„ì„ ê²°ê³¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0ea5e9 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 1.5rem;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .logo-mark {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #020617;
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: 0.14em;
      margin-bottom: 1rem;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .meta {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    
    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 1.2rem;
      padding: 2rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.7);
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #e5e7eb;
    }
    
    .video-wrapper {
      position: relative;
      width: 100%;
      border-radius: 0.8rem;
      overflow: hidden;
      background: #000;
      margin-bottom: 1rem;
    }
    
    video {
      width: 100%;
      display: block;
    }
    
    .swing-info {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }
    
    .info-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      background: rgba(14, 165, 233, 0.2);
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .metric-card {
      background: rgba(15, 23, 42, 0.6);
      padding: 1.2rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    
    .metric-label {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    
    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #22c55e;
    }
    
    .metric-unit {
      font-size: 1rem;
      color: #cbd5e1;
      margin-left: 0.3rem;
    }
    
    .feelings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.8rem;
      margin-bottom: 1rem;
    }
    
    .feeling-btn {
      padding: 0.8rem;
      border-radius: 0.8rem;
      border: 2px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.6);
      color: #e5e7eb;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .feeling-btn:hover {
      border-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.1);
    }
    
    .feeling-btn.selected {
      border-color: #f97316;
      background: rgba(249, 115, 22, 0.2);
      color: #f97316;
    }
    
    .feeling-icon {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.3rem;
    }
    
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.8rem;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
      font-size: 0.9rem;
      font-family: inherit;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #0ea5e9;
    }
    
    textarea::placeholder {
      color: #64748b;
    }
    
    .btn-group {
      display: flex;
      gap: 0.8rem;
    }
    
    .btn {
      flex: 1;
      padding: 0.9rem;
      border-radius: 999px;
      border: none;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.16s ease-out, box-shadow 0.16s ease-out;
    }
    
    .btn-primary {
      background: #f97316;
      color: #111827;
    }
    
    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.6);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.9rem;
      min-height: 1.5rem;
    }
    
    .status.error { color: #fecaca; }
    .status.success { color: #bbf7d0; }
    
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      .card { padding: 1.5rem; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .feelings-grid { grid-template-columns: repeat(2, 1fr); }
      .btn-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="logo-mark">INSWING</span>
      <h1>ìŠ¤ìœ™ ë¶„ì„ ê²°ê³¼</h1>
      <p class="meta" id="metaInfo">ë¶„ì„ ì¼ì‹œ: <span id="dateInfo"></span></p>
    </div>

    <!-- ë¹„ë””ì˜¤ -->
    <div class="card">
      <div class="video-wrapper">
        <video id="swingVideo" controls controlsList="nodownload"></video>
      </div>
      <div class="swing-info">
        <span class="info-badge" id="clubBadge">í´ëŸ½: -</span>
        <span class="info-badge" id="sideBadge">ì´¬ì˜: -</span>
      </div>
    </div>

    <!-- AI ë¶„ì„ ê²°ê³¼ -->
    <div class="card">
      <div class="section-title">AI ë¶„ì„ ê²°ê³¼ (5ê°œ í•µì‹¬ ì§€í‘œ)</div>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">íšŒì „ íš¨ìœ¨</div>
          <div class="metric-value">
            <span id="metricRotation">-</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">ê· í˜• ì•ˆì •ì„±</div>
          <div class="metric-value">
            <span id="metricBalance">-</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">ë°±ìŠ¤ìœ™ ê°ë„</div>
          <div class="metric-value">
            <span id="metricBackswing">-</span>
            <span class="metric-unit">Â°</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">ì„íŒ©íŠ¸ ì†ë„</div>
          <div class="metric-value">
            <span id="metricSpeed">-</span>
            <span class="metric-unit">km/h</span>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-label">íŒ”ë¡œìš°ìŠ¤ë£¨ ê°ë„</div>
          <div class="metric-value">
            <span id="metricFollow">-</span>
            <span class="metric-unit">Â°</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ì˜¤ëŠ˜ ìŠ¤ìœ™ ëŠë‚Œ ì„ íƒ -->
    <div class="card">
      <div class="section-title">ì˜¤ëŠ˜ ìŠ¤ìœ™ ëŠë‚Œ ì„ íƒ</div>
      <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 1rem;">
        ìŠ¤ìœ™ ì¤‘ ëŠê¼ˆë˜ ê°ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš” (ì„ íƒ)
      </p>
      
      <div class="feelings-grid">
        <button class="feeling-btn" data-feeling="LIGHT_SMOOTH">
          <span class="feeling-icon">âœ¨</span>
          ê°€ë³ê³  ë¶€ë“œëŸ¬ì›€
        </button>
        <button class="feeling-btn" data-feeling="FAST">
          <span class="feeling-icon">âš¡</span>
          ë¹ ë¥´ê³  ê°•í•¨
        </button>
        <button class="feeling-btn" data-feeling="TENSE">
          <span class="feeling-icon">ğŸ˜°</span>
          ê¸´ì¥ë˜ê³  ë»£ë»£í•¨
        </button>
        <button class="feeling-btn" data-feeling="UNSTABLE">
          <span class="feeling-icon">ğŸŒ€</span>
          ë¶ˆì•ˆì •í•¨
        </button>
        <button class="feeling-btn" data-feeling="SOLID">
          <span class="feeling-icon">ğŸ’ª</span>
          íƒ„íƒ„í•˜ê³  ì•ˆì •ì 
        </button>
      </div>

      <div style="margin-top: 1.5rem;">
        <label style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; color: #cbd5e1;">
          ì¶”ê°€ ë©”ëª¨ (ì„ íƒ)
        </label>
        <textarea 
          id="noteInput" 
          placeholder="ì˜¤ëŠ˜ ìŠ¤ìœ™ì— ëŒ€í•´ ê¸°ì–µí•˜ê³  ì‹¶ì€ ì ì„ ì ì–´ì£¼ì„¸ìš”..."
        ></textarea>
      </div>

      <div class="btn-group" style="margin-top: 1.5rem;">
        <button class="btn btn-primary" id="saveBtn">
          ëŠë‚Œ ì €ì¥í•˜ê¸°
        </button>
        <a href="/app/history.html" class="btn btn-secondary" style="text-align: center; line-height: 1.2;">
          íˆìŠ¤í† ë¦¬ë¡œ ê°€ê¸°
        </a>
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script src="/app/js/app.js"></script>
  <script>
    requireLogin();

    const swingId = getQueryParam('swing_id');
    if (!swingId) {
      alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
      window.location.href = '/app/history.html';
    }

    let selectedFeeling = null;

    // ëŠë‚Œ ë²„íŠ¼ í´ë¦­
    document.querySelectorAll('.feeling-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.feeling-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedFeeling = btn.dataset.feeling;
      });
    });

    // ë°ì´í„° ë¡œë“œ
    loadSwingData();

    async function loadSwingData() {
      try {
        const res = await apiFetch('/api/swings/' + swingId);
        if (!res.ok) throw new Error('ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
        
        const data = await res.json();
        const swing = data.swing;
        const metrics = data.metrics;
        const feeling = data.feeling;

        // ë‚ ì§œ
        const date = new Date(swing.created_at).toLocaleString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('dateInfo').textContent = date;

        // ë¹„ë””ì˜¤
        document.getElementById('swingVideo').src = swing.video_url;

        // ì •ë³´
        const clubNames = {
          'driver': 'ë“œë¼ì´ë²„',
          'wood': 'ìš°ë“œ',
          'iron': 'ì•„ì´ì–¸',
          'wedge': 'ì›¨ì§€',
          'putter': 'í¼í„°'
        };
        const sideNames = {
          'front': 'ì •ë©´',
          'back': 'í›„ë©´',
          'side': 'ì¸¡ë©´'
        };
        document.getElementById('clubBadge').textContent = 'í´ëŸ½: ' + (clubNames[swing.club_type] || swing.club_type);
        document.getElementById('sideBadge').textContent = 'ì´¬ì˜: ' + (sideNames[swing.shot_side] || swing.shot_side);

        // ë©”íŠ¸ë¦­ìŠ¤
        document.getElementById('metricRotation').textContent = '-'; // TODO: ì‹¤ì œ ë°ì´í„°
        document.getElementById('metricBalance').textContent = metrics.balance_score || '-';
        document.getElementById('metricBackswing').textContent = metrics.backswing_angle || '-';
        document.getElementById('metricSpeed').textContent = metrics.impact_speed || '-';
        document.getElementById('metricFollow').textContent = metrics.follow_through_angle || '-';

        // ê¸°ì¡´ ëŠë‚Œ í‘œì‹œ
        if (feeling && feeling.feeling_code) {
          selectedFeeling = feeling.feeling_code;
          const btn = document.querySelector(`[data-feeling="${feeling.feeling_code}"]`);
          if (btn) btn.classList.add('selected');
          
          if (feeling.note) {
            document.getElementById('noteInput').value = feeling.note;
          }
        }

      } catch (err) {
        console.error(err);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = '/app/history.html';
      }
    }

    // ì €ì¥
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!selectedFeeling) {
        document.getElementById('status').textContent = 'ëŠë‚Œì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        document.getElementById('status').className = 'status error';
        return;
      }

      const note = document.getElementById('noteInput').value.trim();
      const saveBtn = document.getElementById('saveBtn');
      const statusEl = document.getElementById('status');

      saveBtn.disabled = true;
      statusEl.textContent = 'ì €ì¥ ì¤‘...';
      statusEl.className = 'status';

      try {
        const res = await apiFetch('/api/swings/' + swingId + '/feeling', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            feeling_code: selectedFeeling,
            note: note
          })
        });

        if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

        statusEl.textContent = 'ì €ì¥ ì™„ë£Œ! âœ“';
        statusEl.className = 'status success';

        setTimeout(() => {
          statusEl.textContent = '';
        }, 2000);

      } catch (err) {
        console.error(err);
        statusEl.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + err.message;
        statusEl.className = 'status error';
      } finally {
        saveBtn.disabled = false;
      }
    });
  </script>
</body>
</html>