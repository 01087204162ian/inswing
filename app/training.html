<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¸ë ˆì´ë‹ - INSWING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.6);
            z-index: 100;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-logo-mark {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 0.14em;
        }

        .nav-logo-text {
            color: #e5e7eb;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap; /* í•œê¸€ ë©”ë‰´ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .nav-link:hover {
            color: #e5e7eb;
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .nav-link.active {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .nav-link.logout {
            color: #f97316;
        }

        .nav-link.logout:hover {
            background: rgba(249, 115, 22, 0.1);
            border-color: rgba(249, 115, 22, 0.3);
        }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* íŠ¸ë ˆì´ë‹ ì „ìš© ìŠ¤íƒ€ì¼ */
        .training-title {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: #e5e7eb;
        }

        .training-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .back-to-result-link {
            font-size: 0.8rem;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.6);
            color: #93c5fd;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .back-to-result-link:hover {
            border-color: #38bdf8;
            background: rgba(59, 130, 246, 0.2);
            color: #e5f2ff;
        }

        .training-subtitle {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .training-card {
            margin-bottom: 1.5rem;
        }

        .training-focus-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .training-focus-list h3 {
            font-size: 1rem;
            color: #e5e7eb;
            margin-bottom: 0.2rem;
        }

        .training-focus-list p {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.5;
        }

        .training-routine-list {
            list-style: none;
            padding: 0;
            margin: 0.8rem 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .training-routine-list label {
            font-size: 0.9rem;
            color: #cbd5e1;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            cursor: pointer;
        }

        .training-routine-list input[type='checkbox'] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* í›ˆë ¨ ê¸°ë¡ ë³´ê¸° */
        .training-logs-footer {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.85rem;
        }

        .training-logs-link {
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.7);
            color: #e5e7eb;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .training-logs-link:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.12);
            color: #bbf7d0;
        }

        .training-logs-count {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        /* ëª¨ë‹¬ */
        .training-logs-modal.hidden {
            display: none;
        }

        .training-logs-modal {
            position: fixed;
            inset: 0;
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .training-logs-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
        }

        .training-logs-dialog {
            position: relative;
            max-width: 480px;
            width: 90%;
            max-height: 70vh;
            background: rgba(15, 23, 42, 0.98);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 1rem 1.25rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
        }

        .training-logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .training-logs-header h3 {
            font-size: 1rem;
            color: #e5e7eb;
        }

        .training-logs-close {
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 1rem;
            cursor: pointer;
        }

        .training-logs-close:hover {
            color: #f97316;
        }

        .training-logs-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.25rem;
            font-size: 0.85rem;
        }

        .training-logs-empty {
            color: #9ca3af;
            padding: 0.75rem 0.25rem;
        }

        .training-log-item {
            padding: 0.6rem 0.3rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .training-log-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.78rem;
            color: #9ca3af;
        }

        .training-log-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .training-log-tag {
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 0.75rem;
            color: #e5e7eb;
        }

        .training-summary {
            font-size: 0.9rem;
            color: #e5e7eb;
            line-height: 1.6;
            margin-bottom: 0.8rem;
        }

        .training-memo-label {
            display: block;
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.3rem;
        }

        .training-memo-input {
            width: 100%;
            min-height: 80px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: #e5e7eb;
            font-size: 0.9rem;
            padding: 0.6rem 0.75rem;
            resize: vertical;
        }

        .training-memo-input:focus {
            outline: none;
            border-color: #0ea5e9;
            background: rgba(15, 23, 42, 0.95);
        }

        .training-save-btn {
            margin-top: 0.6rem;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error-message {
            text-align: center;
            padding: 2rem 1rem;
            color: #f87171;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .retry-btn {
            margin-top: 1rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .top-nav {
                height: 56px;
                padding: 0 0.75rem;
                overflow-x: auto; /* ë„ˆë¬´ ì¢ìœ¼ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ ì²˜ë¦¬ */
            }

            body {
                padding-top: 72px;
            }

            .nav-logo-text {
                display: none;
            }

            .nav-menu {
                gap: 0.3rem;
                flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ ìœ ì§€ */
            }

            .nav-link {
                padding: 0.35rem 0.65rem;
                font-size: 0.78rem;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.2rem;
            }

            .training-title {
                font-size: 1.4rem;
            }

            .training-header-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="top-nav">
        <a href="/ko/index.html" class="nav-logo">
            <span class="nav-logo-mark">INS</span>
            <span class="nav-logo-text">WING</span>
        </a>
        <div class="nav-menu">
            <a href="/app/upload.html" class="nav-link">ì—…ë¡œë“œ</a>
            <a href="/app/history.html" class="nav-link">íˆìŠ¤í† ë¦¬</a>
            <a href="/app/training.html" class="nav-link active">íŠ¸ë ˆì´ë‹</a>
            <a href="/app/routine.html" class="nav-link">ë£¨í‹´</a>
            <a href="#" onclick="logout(); return false;" class="nav-link logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container">
        <!-- â‘  ì˜¤ëŠ˜ì˜ í•µì‹¬ í¬ì¸íŠ¸ ì¹´ë“œ -->
        <div class="card training-card">
            <div class="training-header-row">
                <h1 class="training-title">ì˜¤ëŠ˜ ì´ ìŠ¤ìœ™ìœ¼ë¡œ ì§‘ì¤‘í•  3ê°€ì§€</h1>
                <a id="backToResultLink" href="#" class="back-to-result-link">ë¶„ì„ í™”ë©´ ë‹¤ì‹œ ë³´ê¸°</a>
            </div>
            <p class="training-subtitle">
                ë°©ê¸ˆ ë¶„ì„í•œ ìŠ¤ìœ™ì„ ê¸°ì¤€ìœ¼ë¡œ, ì˜¤ëŠ˜ ì—°ìŠµì¥ì—ì„œ ê¼­ ì±™ê¸°ë©´ ì¢‹ì€ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.
            </p>

            <div id="trainingLoading" class="loading-dots" style="text-align: center; padding: 2rem; color: #94a3b8;">
                íŠ¸ë ˆì´ë‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <ol id="trainingFocusList" class="training-focus-list" style="display: none;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ í¬ì¸íŠ¸ ëª©ë¡ -->
            </ol>
        </div>

        <!-- â‘¡ ì—°ìŠµ ë£¨í‹´ ì¹´ë“œ (ì²´í¬ UI) -->
        <div class="card training-card">
            <h2 class="section-title">ì˜¤ëŠ˜ ì—°ìŠµ ë£¨í‹´</h2>
            <p class="training-subtitle">
                ì—°ìŠµì´ ëë‚œ í›„ ì•„ë˜ í•­ëª©ë“¤ì„ ì²´í¬í•´ ë³´ì„¸ìš”. ë£¨í‹´ ë‹¬ì„±ì´ ìŒ“ì´ë©´ ì‹¤ë ¥ì´ ì•ˆì •ë©ë‹ˆë‹¤.
            </p>

            <div id="routineLoading" class="loading-dots" style="text-align: center; padding: 1rem; color: #94a3b8; display: none;">
                ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <ul id="trainingRoutineList" class="training-routine-list" style="display: none;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë£¨í‹´ ëª©ë¡ -->
            </ul>
            <div class="training-logs-footer">
                <button id="viewTrainingLogsBtn" class="training-logs-link">
                    ì´ ìŠ¤ìœ™ í›ˆë ¨ ê¸°ë¡ ë³´ëŸ¬ê°€ê¸°
                </button>
                <span id="trainingLogsCount" class="training-logs-count">
                    ê¸°ë¡ 0íšŒ
                </span>
            </div>

            <button id="saveRoutineBtn" class="btn-primary training-save-btn" disabled>
                ì˜¤ëŠ˜ ì—°ìŠµ ê¸°ë¡ ë‚¨ê¸°ê¸°
            </button>
        </div>

        <!-- â‘¢ ì½”ì¹­ ìš”ì•½ & ë©”ëª¨ ì¹´ë“œ -->
        <div class="card training-card">
            <h2 class="section-title">ì˜¤ëŠ˜ ì½”ì¹­ í•œ ì¤„ ìš”ì•½</h2>
            <div id="summaryLoading" class="loading-dots" style="text-align: center; padding: 1rem; color: #94a3b8;">
                ì½”ì¹­ ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            <p id="trainingCoachSummary" class="training-summary" style="display: none;">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ì½”ì¹­ ìš”ì•½ -->
            </p>

            <label for="trainingMemo" class="training-memo-label">
                ì˜¤ëŠ˜ ì—°ìŠµ í›„ ëŠë‚€ ì ì„ ê°„ë‹¨íˆ ë‚¨ê²¨ë³´ì„¸ìš”. (ë‚˜ë§Œ ë³´ëŠ” ë©”ëª¨)
            </label>
            <textarea
                id="trainingMemo"
                class="training-memo-input"
                placeholder="ì˜ˆ: í”¼ë‹ˆì‹œëŠ” ì¢‹ì•„ì¡ŒëŠ”ë°, ê¸´ ì•„ì´ì–¸ì—ì„œ í…œí¬ê°€ ë‹¤ì‹œ ë¹¨ë¼ì§€ëŠ” ëŠë‚Œì´ì—ˆë‹¤."
            ></textarea>
        </div>
    </div>

    <!-- í›ˆë ¨ ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="trainingLogsModal" class="training-logs-modal hidden">
        <div class="training-logs-backdrop"></div>
        <div class="training-logs-dialog">
            <div class="training-logs-header">
                <h3>ì´ ìŠ¤ìœ™ í›ˆë ¨ ê¸°ë¡</h3>
                <button id="closeTrainingLogsBtn" class="training-logs-close">âœ•</button>
            </div>
            <div id="trainingLogsBody" class="training-logs-body">
                <div class="training-logs-empty">
                    ì•„ì§ ì´ ìŠ¤ìœ™ìœ¼ë¡œ ì €ì¥ëœ í›ˆë ¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="/app/js/app.js"></script>
    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        requireLogin();

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        const swingId = getQueryParam('id');
        let trainingLogsCache = null;
        console.log('[Training] swingId:', swingId);

        // swingIdê°€ ì—†ìœ¼ë©´ íˆìŠ¤í† ë¦¬ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (!swingId) {
            console.warn('[Training] swingId ì—†ìŒ â†’ íˆìŠ¤í† ë¦¬ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
            window.location.href = '/app/history.html';
        }

        const backToResultLink = document.getElementById('backToResultLink');
        if (backToResultLink) {
            if (swingId) {
                backToResultLink.href = `/app/result.html?id=${encodeURIComponent(swingId)}`;
            } else {
                backToResultLink.style.display = 'none';
            }
            console.log('[Training] ë¶„ì„ í™”ë©´ ë‹¤ì‹œ ë³´ê¸° ë§í¬ ì„¤ì • ì™„ë£Œ, swingId:', swingId);
        }

        // ===== DOM ìš”ì†Œ ì°¸ì¡° =====
        const focusListEl = document.getElementById('trainingFocusList');
        const focusLoadingEl = document.getElementById('trainingLoading');
        const routineListEl = document.getElementById('trainingRoutineList');
        const routineLoadingEl = document.getElementById('routineLoading');
        const summaryEl = document.getElementById('trainingCoachSummary');
        const summaryLoadingEl = document.getElementById('summaryLoading');
        const saveRoutineBtn = document.getElementById('saveRoutineBtn');
        const trainingLogsCountEl = document.getElementById('trainingLogsCount');
        const viewTrainingLogsBtn = document.getElementById('viewTrainingLogsBtn');

        // ===== API í˜¸ì¶œ =====
        async function loadTrainingData(swingId) {
            try {
                console.log('[Training] íŠ¸ë ˆì´ë‹ ë°ì´í„° ë¡œë“œ ì‹œì‘, swingId:', swingId);

                const response = await apiFetch(`/v1/swings/${swingId}/training`);

                if (!response.ok) {
                    if (response.status === 404) {
                        showError('ì´ ìŠ¤ìœ™ì€ ì•„ì§ íŠ¸ë ˆì´ë‹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
                }

                const data = await response.json();
                console.log('[Training] íŠ¸ë ˆì´ë‹ ë°ì´í„° ìˆ˜ì‹ :', data);

                // === DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ===
                const focusListElDirect = document.getElementById('trainingFocusList');
                const routineListElDirect = document.getElementById('trainingRoutineList');
                const summaryElDirect = document.getElementById('trainingCoachSummary');

                if (!focusListElDirect || !routineListElDirect || !summaryElDirect) {
                    console.warn('[Training] ì¼ë¶€ DOM ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                // === 1. ì§‘ì¤‘ í¬ì¸íŠ¸ 3ê°€ì§€ ì±„ìš°ê¸° ===
                if (focusLoadingEl) focusLoadingEl.style.display = 'none';
                focusListElDirect.innerHTML = ''; // ê¸°ì¡´ ë”ë¯¸ ë‚´ìš© ì œê±°

                (data.focus || []).forEach((text, idx) => {
                    const li = document.createElement('li');

                    const title = document.createElement('h3');
                    title.textContent = `${idx + 1}. ${text}`;
                    title.style.fontSize = '1rem';

                    // ì„¤ëª…ì€ ë‚˜ì¤‘ì— AI í™•ì¥ìš©, ì§€ê¸ˆì€ í•œ ì¤„ í…ìŠ¤íŠ¸ë§Œ
                    const desc = document.createElement('p');
                    desc.textContent = ''; // í•„ìš”í•˜ë©´ ê¸°ë³¸ ë©˜íŠ¸ ë„£ê¸°

                    li.appendChild(title);
                    li.appendChild(desc);
                    focusListElDirect.appendChild(li);
                });
                focusListElDirect.style.display = 'block';

                // === 2. ì˜¤ëŠ˜ ì—°ìŠµ ë£¨í‹´ ì±„ìš°ê¸° ===
                if (routineLoadingEl) routineLoadingEl.style.display = 'none';
                routineListElDirect.innerHTML = '';

                (data.routine_items || []).forEach((item, idx) => {
                    const li = document.createElement('li');
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');

                    checkbox.type = 'checkbox';
                    checkbox.dataset.index = String(idx);

                    const textNode = document.createTextNode(' ' + item);

                    label.appendChild(checkbox);
                    label.appendChild(textNode);
                    li.appendChild(label);
                    routineListElDirect.appendChild(li);
                });
                routineListElDirect.style.display = 'block';

                // === 3. ì½”ì¹­ í•œ ì¤„ ìš”ì•½ ì±„ìš°ê¸° ===
                if (summaryLoadingEl) summaryLoadingEl.style.display = 'none';
                summaryElDirect.textContent =
                    data.coach_summary ||
                    'ì˜¤ëŠ˜ì€ ì´ ìŠ¤ìœ™ì„ ê¸°ì¤€ìœ¼ë¡œ, í”¼ë‹ˆì‹œì™€ ë¦¬ë“¬ì— ì§‘ì¤‘í•´ ì—°ìŠµí•´ ë³´ì„¸ìš”.';
                summaryElDirect.style.display = 'block';

                // === 4. ë£¨í‹´ ì €ì¥ ë²„íŠ¼ í™œì„±í™” ===
                if (saveRoutineBtn) {
                    saveRoutineBtn.disabled = false;
                    saveRoutineBtn.style.opacity = '1';
                    saveRoutineBtn.style.cursor = 'pointer';
                }

                // === 5. í›ˆë ¨ ê¸°ë¡ ìš”ì•½ ë¡œë“œ ===
                loadTrainingLogsSummary(swingId);

            } catch (error) {
                console.error('[Training] ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('íŠ¸ë ˆì´ë‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
            }
        }

        // ===== UI ë Œë”ë§ =====
        function renderFocusPoints(focusArray) {
            if (!focusListEl || !focusLoadingEl) return;

            focusLoadingEl.style.display = 'none';

            if (!focusArray || focusArray.length === 0) {
                focusListEl.innerHTML = '<li style="color: #94a3b8; font-style: italic;">í¬ì¸íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                focusListEl.style.display = 'block';
                return;
            }

            focusListEl.innerHTML = focusArray.map((item, index) => {
                // itemì´ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ, ê°ì²´ë©´ title/description ì¶”ì¶œ
                const title = typeof item === 'string' ? item : (item.title || item.name || `í¬ì¸íŠ¸ ${index + 1}`);
                const description = typeof item === 'string' ? '' : (item.description || item.desc || '');

                return `
                    <li>
                        <h3>${index + 1}. ${title}</h3>
                        ${description ? `<p>${description}</p>` : ''}
                    </li>
                `;
            }).join('');

            focusListEl.style.display = 'block';
        }

        function renderRoutineItems(routineArray) {
            if (!routineListEl || !routineLoadingEl) return;

            routineLoadingEl.style.display = 'none';

            if (!routineArray || routineArray.length === 0) {
                routineListEl.innerHTML = '<li style="color: #94a3b8; font-style: italic;">ë£¨í‹´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                routineListEl.style.display = 'block';
                return;
            }

            routineListEl.innerHTML = routineArray.map((item, index) => {
                const text = typeof item === 'string' ? item : (item.text || item.name || `ë£¨í‹´ ${index + 1}`);
                return `
                    <li>
                        <label>
                            <input type="checkbox" data-routine-index="${index}" />
                            ${text}
                        </label>
                    </li>
                `;
            }).join('');

            routineListEl.style.display = 'block';
        }

        function renderSummary(summaryText) {
            if (!summaryEl || !summaryLoadingEl) return;

            summaryLoadingEl.style.display = 'none';

            if (!summaryText || summaryText.trim() === '') {
                summaryEl.textContent = 'ì½”ì¹­ ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.';
                summaryEl.style.display = 'block';
                return;
            }

            summaryEl.textContent = summaryText;
            summaryEl.style.display = 'block';
        }

        // ===== ì—ëŸ¬ ì²˜ë¦¬ =====
        function showError(message, showRetry = false) {
            // í¬ì¸íŠ¸ ì˜ì—­ì— ì—ëŸ¬ í‘œì‹œ
            if (focusLoadingEl) {
                focusLoadingEl.innerHTML = `<div class="error-message">${message}${showRetry ? '<br><button class="retry-btn" onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>' : ''}</div>`;
            }

            // ë£¨í‹´ ì˜ì—­ ìˆ¨ê¹€
            if (routineLoadingEl) routineLoadingEl.style.display = 'none';
            if (routineListEl) routineListEl.style.display = 'none';

            // ìš”ì•½ ì˜ì—­ ìˆ¨ê¹€
            if (summaryLoadingEl) summaryLoadingEl.style.display = 'none';
            if (summaryEl) summaryEl.style.display = 'none';
        }

        // ===== í›ˆë ¨ ê¸°ë¡ ìš”ì•½ ë¡œë“œ =====
        async function loadTrainingLogsSummary(swingIdValue) {
            if (!trainingLogsCountEl || !swingIdValue) return;
            try {
                const resp = await apiFetch(`/v1/swings/${swingIdValue}/training-logs`);
                if (!resp.ok) {
                    console.warn('[Training] í›ˆë ¨ ê¸°ë¡ ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨:', resp.status, resp.statusText);
                    trainingLogsCountEl.textContent = 'ê¸°ë¡ 0íšŒ';
                    return;
                }
                const data = await resp.json();
                trainingLogsCache = data.logs || [];
                const count = data.count || trainingLogsCache.length || 0;
                trainingLogsCountEl.textContent = `ê¸°ë¡ ${count}íšŒ`;
            } catch (err) {
                console.error('[Training] í›ˆë ¨ ê¸°ë¡ ìš”ì•½ ì¡°íšŒ ì˜¤ë¥˜:', err);
            }
        }

        // ===== í›ˆë ¨ ê¸°ë¡ ëª¨ë‹¬ ë Œë” =====
        function openTrainingLogsModal() {
            const modal = document.getElementById('trainingLogsModal');
            const bodyEl = document.getElementById('trainingLogsBody');
            if (!modal || !bodyEl) return;

            modal.classList.remove('hidden');
            bodyEl.innerHTML = '';

            if (!trainingLogsCache || trainingLogsCache.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'training-logs-empty';
                emptyDiv.textContent = 'ì•„ì§ ì´ ìŠ¤ìœ™ìœ¼ë¡œ ì €ì¥ëœ í›ˆë ¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                bodyEl.appendChild(emptyDiv);
                return;
            }

            trainingLogsCache.forEach((log) => {
                const item = document.createElement('div');
                item.className = 'training-log-item';

                const meta = document.createElement('div');
                meta.className = 'training-log-meta';

                const dateStr = new Date(log.created_at).toLocaleString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const left = document.createElement('span');
                left.textContent = dateStr;

                const right = document.createElement('span');
                const completedCount = Array.isArray(log.completed_items)
                    ? log.completed_items.length
                    : 0;
                right.textContent = `ì™„ë£Œ ${completedCount}/${log.total_items}`;

                meta.appendChild(left);
                meta.appendChild(right);

                const tags = document.createElement('div');
                tags.className = 'training-log-tags';

                (log.completed_items || []).forEach((text) => {
                    const tag = document.createElement('span');
                    tag.className = 'training-log-tag';
                    tag.textContent = text;
                    tags.appendChild(tag);
                });

                item.appendChild(meta);
                item.appendChild(tags);
                bodyEl.appendChild(item);
            });
        }

        function closeTrainingLogsModal() {
            const modal = document.getElementById('trainingLogsModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        // ===== ë£¨í‹´ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ =====
        if (saveRoutineBtn) {
            saveRoutineBtn.addEventListener('click', async () => {
                const routineListElDom = document.getElementById('trainingRoutineList');
                if (!routineListElDom) return;

                const checkboxes = routineListElDom.querySelectorAll('input[type="checkbox"]');
                const completedItems = [];

                checkboxes.forEach((cb) => {
                    if (cb.checked) {
                        const label = cb.closest('label');
                        if (label) {
                            const text = label.textContent.trim();
                            if (text) completedItems.push(text);
                        }
                    }
                });

                if (completedItems.length === 0) {
                    alert('ì˜¤ëŠ˜ ì™„ë£Œí•œ ë£¨í‹´ì„ í•˜ë‚˜ ì´ìƒ ì²´í¬í•´ ì£¼ì„¸ìš”.');
                    return;
                }

                // ì €ì¥ ì‹œì‘
                saveRoutineBtn.disabled = true;
                saveRoutineBtn.textContent = 'ê¸°ë¡í•˜ëŠ” ì¤‘...';

                try {
                    const resp = await apiFetch('/v1/training-sessions', {
                        method: 'POST',
                        body: JSON.stringify({
                            swing_id: Number(swingId),
                            completed_items: completedItems,
                            total_items: checkboxes.length
                        })
                    });

                    if (!resp.ok) {
                        console.error('[Training] ë£¨í‹´ ì €ì¥ ì‹¤íŒ¨:', resp.status, resp.statusText);
                        alert('ë£¨í‹´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                        saveRoutineBtn.disabled = false;
                        saveRoutineBtn.textContent = 'ì˜¤ëŠ˜ ì—°ìŠµ ê¸°ë¡ ë‚¨ê¸°ê¸°';
                        return;
                    }

                    // ì €ì¥ ì„±ê³µ
                    saveRoutineBtn.textContent = 'ê¸°ë¡ ì™„ë£Œ! ì˜¤ëŠ˜ ì¢‹ì•˜ìŠµë‹ˆë‹¤ ğŸ‘';

                    // ë¡œê·¸ ì¬ë¡œë”© (ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸)
                    loadTrainingLogsSummary(swingId);

                    // 3ì´ˆ í›„ ë‹¤ì‹œ ì €ì¥ ê°€ëŠ¥ ìƒíƒœ
                    setTimeout(() => {
                        saveRoutineBtn.disabled = false;
                        saveRoutineBtn.textContent = 'ì—°ìŠµ ë” í•˜ê³  ê¸°ë¡ ì¶”ê°€í•˜ê¸°';
                    }, 3000);
                } catch (err) {
                    console.error('[Training] ë£¨í‹´ ì €ì¥ ì˜¤ë¥˜:', err);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
                    saveRoutineBtn.disabled = false;
                    saveRoutineBtn.textContent = 'ì˜¤ëŠ˜ ì—°ìŠµ ê¸°ë¡ ë‚¨ê¸°ê¸°';
                }
            });
        }

        // ===== ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
        const closeTrainingLogsBtn = document.getElementById('closeTrainingLogsBtn');
        const trainingLogsModal = document.getElementById('trainingLogsModal');
        const trainingLogsBackdrop = trainingLogsModal ? trainingLogsModal.querySelector('.training-logs-backdrop') : null;

        if (viewTrainingLogsBtn) {
            viewTrainingLogsBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                if (trainingLogsCache === null && swingId) {
                    await loadTrainingLogsSummary(swingId);
                }
                openTrainingLogsModal();
            });
        }

        if (closeTrainingLogsBtn) {
            closeTrainingLogsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                closeTrainingLogsModal();
            });
        }

        if (trainingLogsBackdrop) {
            trainingLogsBackdrop.addEventListener('click', (e) => {
                e.preventDefault();
                closeTrainingLogsModal();
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTrainingLogsModal();
            }
        });

        console.log('[Training] ì˜¤ëŠ˜ ë£¨í‹´ ì™„ë£Œ ì €ì¥ ê¸°ëŠ¥ í™œì„±í™”');
        console.log('[Training] ë£¨í‹´ ì €ì¥ ë²„íŠ¼ UX ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        console.log('[Training] ì´ ìŠ¤ìœ™ í›ˆë ¨ ê¸°ë¡ ëª¨ë‹¬ ê¸°ëŠ¥ í™œì„±í™”');

        // ===== ì´ˆê¸°í™” =====
        if (swingId) {
            loadTrainingData(swingId);
        }
    </script>
</body>
</html>

