<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>트레이닝 - INSWING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* 네비게이션 바 */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.6);
            z-index: 100;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .nav-logo-mark {
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 0.14em;
        }

        .nav-logo-text {
            color: #e5e7eb;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
            white-space: nowrap; /* 한글 메뉴 줄바꿈 방지 */
        }

        .nav-link:hover {
            color: #e5e7eb;
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .nav-link.active {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            border-color: rgba(14, 165, 233, 0.3);
        }

        .nav-link.logout {
            color: #f97316;
        }

        .nav-link.logout:hover {
            background: rgba(249, 115, 22, 0.1);
            border-color: rgba(249, 115, 22, 0.3);
        }

        /* 메인 컨텐츠 */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* 트레이닝 전용 스타일 */
        .training-title {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: #e5e7eb;
        }

        .training-subtitle {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .training-card {
            margin-bottom: 1.5rem;
        }

        .training-focus-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .training-focus-list h3 {
            font-size: 1rem;
            color: #e5e7eb;
            margin-bottom: 0.2rem;
        }

        .training-focus-list p {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.5;
        }

        .training-routine-list {
            list-style: none;
            padding: 0;
            margin: 0.8rem 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .training-routine-list label {
            font-size: 0.9rem;
            color: #cbd5e1;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            cursor: pointer;
        }

        .training-routine-list input[type='checkbox'] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .training-summary {
            font-size: 0.9rem;
            color: #e5e7eb;
            line-height: 1.6;
            margin-bottom: 0.8rem;
        }

        .training-memo-label {
            display: block;
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 0.3rem;
        }

        .training-memo-input {
            width: 100%;
            min-height: 80px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: #e5e7eb;
            font-size: 0.9rem;
            padding: 0.6rem 0.75rem;
            resize: vertical;
        }

        .training-memo-input:focus {
            outline: none;
            border-color: #0ea5e9;
            background: rgba(15, 23, 42, 0.95);
        }

        .training-save-btn {
            margin-top: 0.6rem;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error-message {
            text-align: center;
            padding: 2rem 1rem;
            color: #f87171;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .retry-btn {
            margin-top: 1rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9, #22c55e);
            color: #020617;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* 모바일 대응 */
        @media (max-width: 768px) {
            .top-nav {
                height: 56px;
                padding: 0 0.75rem;
                overflow-x: auto; /* 너무 좁으면 가로 스크롤로 처리 */
            }

            body {
                padding-top: 72px;
            }

            .nav-logo-text {
                display: none;
            }

            .nav-menu {
                gap: 0.3rem;
                flex-wrap: nowrap; /* 줄바꿈 없이 한 줄 유지 */
            }

            .nav-link {
                padding: 0.35rem 0.65rem;
                font-size: 0.78rem;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.2rem;
            }

            .training-title {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 -->
    <nav class="top-nav">
        <a href="/ko/index.html" class="nav-logo">
            <span class="nav-logo-mark">INS</span>
            <span class="nav-logo-text">WING</span>
        </a>
        <div class="nav-menu">
            <a href="/app/upload.html" class="nav-link">업로드</a>
            <a href="/app/history.html" class="nav-link">히스토리</a>
            <a href="/app/training.html" class="nav-link active">트레이닝</a>
            <a href="/app/routine.html" class="nav-link">루틴</a>
            <a href="#" onclick="logout(); return false;" class="nav-link logout">로그아웃</a>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="container">
        <!-- ① 오늘의 핵심 포인트 카드 -->
        <div class="card training-card">
            <h1 class="training-title">오늘 이 스윙으로 집중할 3가지</h1>
            <p class="training-subtitle">
                방금 분석한 스윙을 기준으로, 오늘 연습장에서 꼭 챙기면 좋은 포인트입니다.
            </p>

            <div id="trainingLoading" class="loading-dots" style="text-align: center; padding: 2rem; color: #94a3b8;">
                트레이닝 데이터를 불러오는 중...
            </div>
            <ol id="trainingFocusList" class="training-focus-list" style="display: none;">
                <!-- 동적으로 채워질 포인트 목록 -->
            </ol>
        </div>

        <!-- ② 연습 루틴 카드 (체크 UI) -->
        <div class="card training-card">
            <h2 class="section-title">오늘 연습 루틴</h2>
            <p class="training-subtitle">
                연습이 끝난 후 아래 항목들을 체크해 보세요. 루틴 달성이 쌓이면 실력이 안정됩니다.
            </p>

            <div id="routineLoading" class="loading-dots" style="text-align: center; padding: 1rem; color: #94a3b8; display: none;">
                루틴을 불러오는 중...
            </div>
            <ul id="trainingRoutineList" class="training-routine-list" style="display: none;">
                <!-- 동적으로 채워질 루틴 목록 -->
            </ul>

            <button id="saveRoutineBtn" class="btn-primary training-save-btn" disabled>
                (향후) 오늘 루틴 완료로 저장
            </button>
        </div>

        <!-- ③ 코칭 요약 & 메모 카드 -->
        <div class="card training-card">
            <h2 class="section-title">오늘 코칭 한 줄 요약</h2>
            <div id="summaryLoading" class="loading-dots" style="text-align: center; padding: 1rem; color: #94a3b8;">
                코칭 요약을 불러오는 중...
            </div>
            <p id="trainingCoachSummary" class="training-summary" style="display: none;">
                <!-- 동적으로 채워질 코칭 요약 -->
            </p>

            <label for="trainingMemo" class="training-memo-label">
                오늘 연습 후 느낀 점을 간단히 남겨보세요. (나만 보는 메모)
            </label>
            <textarea
                id="trainingMemo"
                class="training-memo-input"
                placeholder="예: 피니시는 좋아졌는데, 긴 아이언에서 템포가 다시 빨라지는 느낌이었다."
            ></textarea>
        </div>
    </div>

    <!-- 스크립트 -->
    <script src="/app/js/app.js"></script>
    <script>
        // 로그인 체크
        requireLogin();

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        const swingId = getQueryParam('id');
        console.log('[Training] swingId:', swingId);

        // swingId가 없으면 히스토리로 리다이렉트
        if (!swingId) {
            console.warn('[Training] swingId 없음 → 히스토리로 리다이렉트');
            window.location.href = '/app/history.html';
        }

        // ===== DOM 요소 참조 =====
        const focusListEl = document.getElementById('trainingFocusList');
        const focusLoadingEl = document.getElementById('trainingLoading');
        const routineListEl = document.getElementById('trainingRoutineList');
        const routineLoadingEl = document.getElementById('routineLoading');
        const summaryEl = document.getElementById('trainingCoachSummary');
        const summaryLoadingEl = document.getElementById('summaryLoading');
        const saveRoutineBtn = document.getElementById('saveRoutineBtn');

        // ===== API 호출 =====
        async function loadTrainingData(swingId) {
            try {
                console.log('[Training] 트레이닝 데이터 로드 시작, swingId:', swingId);

                const response = await apiFetch(`/v1/swings/${swingId}/training`);

                if (!response.ok) {
                    if (response.status === 404) {
                        showError('이 스윙은 아직 트레이닝 데이터가 없습니다.');
                        return;
                    }
                    throw new Error(`서버 오류 (${response.status})`);
                }

                const data = await response.json();
                console.log('[Training] 트레이닝 데이터 수신:', data);

                // === DOM 요소 가져오기 ===
                const focusListElDirect = document.getElementById('trainingFocusList');
                const routineListElDirect = document.getElementById('trainingRoutineList');
                const summaryElDirect = document.getElementById('trainingCoachSummary');

                if (!focusListElDirect || !routineListElDirect || !summaryElDirect) {
                    console.warn('[Training] 일부 DOM 요소를 찾지 못했습니다.');
                    return;
                }

                // === 1. 집중 포인트 3가지 채우기 ===
                if (focusLoadingEl) focusLoadingEl.style.display = 'none';
                focusListElDirect.innerHTML = ''; // 기존 더미 내용 제거

                (data.focus || []).forEach((text, idx) => {
                    const li = document.createElement('li');

                    const title = document.createElement('h3');
                    title.textContent = `${idx + 1}. ${text}`;
                    title.style.fontSize = '1rem';

                    // 설명은 나중에 AI 확장용, 지금은 한 줄 텍스트만
                    const desc = document.createElement('p');
                    desc.textContent = ''; // 필요하면 기본 멘트 넣기

                    li.appendChild(title);
                    li.appendChild(desc);
                    focusListElDirect.appendChild(li);
                });
                focusListElDirect.style.display = 'block';

                // === 2. 오늘 연습 루틴 채우기 ===
                if (routineLoadingEl) routineLoadingEl.style.display = 'none';
                routineListElDirect.innerHTML = '';

                (data.routine_items || []).forEach((item, idx) => {
                    const li = document.createElement('li');
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');

                    checkbox.type = 'checkbox';
                    checkbox.dataset.index = String(idx);

                    const textNode = document.createTextNode(' ' + item);

                    label.appendChild(checkbox);
                    label.appendChild(textNode);
                    li.appendChild(label);
                    routineListElDirect.appendChild(li);
                });
                routineListElDirect.style.display = 'block';

                // === 3. 코칭 한 줄 요약 채우기 ===
                if (summaryLoadingEl) summaryLoadingEl.style.display = 'none';
                summaryElDirect.textContent =
                    data.coach_summary ||
                    '오늘은 이 스윙을 기준으로, 피니시와 리듬에 집중해 연습해 보세요.';
                summaryElDirect.style.display = 'block';

            } catch (error) {
                console.error('[Training] 데이터 로드 오류:', error);
                showError('트레이닝 데이터를 불러오는 중 오류가 발생했습니다.', true);
            }
        }

        // ===== UI 렌더링 =====
        function renderFocusPoints(focusArray) {
            if (!focusListEl || !focusLoadingEl) return;

            focusLoadingEl.style.display = 'none';

            if (!focusArray || focusArray.length === 0) {
                focusListEl.innerHTML = '<li style="color: #94a3b8; font-style: italic;">포인트 데이터가 없습니다.</li>';
                focusListEl.style.display = 'block';
                return;
            }

            focusListEl.innerHTML = focusArray.map((item, index) => {
                // item이 문자열이면 그대로, 객체면 title/description 추출
                const title = typeof item === 'string' ? item : (item.title || item.name || `포인트 ${index + 1}`);
                const description = typeof item === 'string' ? '' : (item.description || item.desc || '');

                return `
                    <li>
                        <h3>${index + 1}. ${title}</h3>
                        ${description ? `<p>${description}</p>` : ''}
                    </li>
                `;
            }).join('');

            focusListEl.style.display = 'block';
        }

        function renderRoutineItems(routineArray) {
            if (!routineListEl || !routineLoadingEl) return;

            routineLoadingEl.style.display = 'none';

            if (!routineArray || routineArray.length === 0) {
                routineListEl.innerHTML = '<li style="color: #94a3b8; font-style: italic;">루틴 데이터가 없습니다.</li>';
                routineListEl.style.display = 'block';
                return;
            }

            routineListEl.innerHTML = routineArray.map((item, index) => {
                const text = typeof item === 'string' ? item : (item.text || item.name || `루틴 ${index + 1}`);
                return `
                    <li>
                        <label>
                            <input type="checkbox" data-routine-index="${index}" />
                            ${text}
                        </label>
                    </li>
                `;
            }).join('');

            routineListEl.style.display = 'block';
        }

        function renderSummary(summaryText) {
            if (!summaryEl || !summaryLoadingEl) return;

            summaryLoadingEl.style.display = 'none';

            if (!summaryText || summaryText.trim() === '') {
                summaryEl.textContent = '코칭 요약이 없습니다.';
                summaryEl.style.display = 'block';
                return;
            }

            summaryEl.textContent = summaryText;
            summaryEl.style.display = 'block';
        }

        // ===== 에러 처리 =====
        function showError(message, showRetry = false) {
            // 포인트 영역에 에러 표시
            if (focusLoadingEl) {
                focusLoadingEl.innerHTML = `<div class="error-message">${message}${showRetry ? '<br><button class="retry-btn" onclick="location.reload()">다시 시도</button>' : ''}</div>`;
            }

            // 루틴 영역 숨김
            if (routineLoadingEl) routineLoadingEl.style.display = 'none';
            if (routineListEl) routineListEl.style.display = 'none';

            // 요약 영역 숨김
            if (summaryLoadingEl) summaryLoadingEl.style.display = 'none';
            if (summaryEl) summaryEl.style.display = 'none';
        }

        // ===== 루틴 저장 버튼 이벤트 =====
        if (saveRoutineBtn) {
            saveRoutineBtn.addEventListener('click', async () => {
                const routineListElDom = document.getElementById('trainingRoutineList');
                if (!routineListElDom) return;

                const checkboxes = routineListElDom.querySelectorAll('input[type="checkbox"]');
                const completedItems = [];

                checkboxes.forEach((cb) => {
                    if (cb.checked) {
                        const label = cb.closest('label');
                        if (label) {
                            const text = label.textContent.trim();
                            if (text) completedItems.push(text);
                        }
                    }
                });

                if (completedItems.length === 0) {
                    alert('오늘 완료한 루틴을 하나 이상 체크해 주세요.');
                    return;
                }

                saveRoutineBtn.disabled = true;
                const originalText = saveRoutineBtn.textContent;
                saveRoutineBtn.textContent = '저장 중...';

                try {
                    const resp = await apiFetch('/v1/training-sessions', {
                        method: 'POST',
                        body: JSON.stringify({
                            swing_id: Number(swingId),
                            completed_items: completedItems,
                            total_items: checkboxes.length
                        })
                    });

                    if (!resp.ok) {
                        console.error('[Training] 루틴 저장 실패:', resp.status, resp.statusText);
                        alert('루틴 저장에 실패했습니다. 잠시 후 다시 시도해 주세요.');
                        saveRoutineBtn.disabled = false;
                        saveRoutineBtn.textContent = originalText;
                        return;
                    }

                    alert('오늘 루틴 기록을 저장했어요 ✅');
                    saveRoutineBtn.textContent = '오늘 루틴 완료 저장됨';
                } catch (err) {
                    console.error('[Training] 루틴 저장 오류:', err);
                    alert('저장 중 오류가 발생했습니다. 네트워크 상태를 확인해 주세요.');
                    saveRoutineBtn.disabled = false;
                    saveRoutineBtn.textContent = originalText;
                }
            });
        }

        console.log('[Training] 오늘 루틴 완료 저장 기능 활성화');

        // ===== 초기화 =====
        if (swingId) {
            loadTrainingData(swingId);
        }
    </script>
</body>
</html>

